services:
  # Redis - Message broker for Celery
  redis:
    image: redis:7-alpine
    container_name: rightmove_redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - rightmove_network
    restart: unless-stopped

  # MinIO - S3-compatible object storage for images
  minio:
    image: minio/minio:latest
    container_name: rightmove_minio
    ports:
      - "9000:9000"      # API
      - "9001:9001"      # Console UI
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      # Option 1: Use local directory (bind mount) - Files accessible on Windows
      - ./minio_storage:/data

      # Option 2: Use Docker volume (uncomment to use instead of bind mount)
      # - minio_data:/data
    networks:
      - rightmove_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Celery Worker - Background task processor
  celery_worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rightmove_worker
    # Volume mounts for live code updates (changes take effect on restart, no rebuild needed)
    volumes:
      - ./scraper:/app/scraper:ro       # Mount scraper code (read-only)
      - ./workers:/app/workers:ro       # Mount workers code (read-only)
      - ./db:/app/db:ro                 # Mount database code (read-only)
      # Note: Don't mount .venv, __pycache__, or other build artifacts
    environment:
      # Redis connection
      REDIS_URL: redis://redis:6379/0

      # MinIO connection
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_SECURE: "false"
      MINIO_BUCKET: property-images

      # Database connection (adjust these to your host PostgreSQL)
      DB_HOST: host.docker.internal  # For Windows/Mac Docker Desktop
      # DB_HOST: 172.17.0.1          # For Linux Docker (uncomment if needed)
      DB_PORT: 5432
      DB_NAME: rightmove_scraper
      DB_USER: postgres
      DB_PASSWORD: 12345

      # Email - SMTP Configuration (reads from .env file)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_USE_TLS: ${SMTP_USE_TLS}
      FROM_NAME: ${FROM_NAME}
      NOTIFICATION_EMAILS: ${NOTIFICATION_EMAILS}

      # Python settings
      PYTHONUNBUFFERED: 1
    depends_on:
      - redis
      - minio
    networks:
      - rightmove_network
    restart: unless-stopped
    # Override command to run specific queues if needed
    # command: celery -A workers.celery_app worker --loglevel=info -Q scraper,geocoding

  # MinIO Client - One-time setup to create bucket
  minio_setup:
    image: minio/mc:latest
    container_name: rightmove_minio_setup
    depends_on:
      - minio
    networks:
      - rightmove_network
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/property-images --ignore-existing;
      mc anonymous set download myminio/property-images;
      echo 'MinIO setup complete';
      exit 0;
      "

networks:
  rightmove_network:
    driver: bridge

volumes:
  redis_data:
    driver: local
  # minio_data:  # Uncomment if using Docker volume instead of bind mount
  #   driver: local
